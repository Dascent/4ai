<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Quote Image Maker</title>
<link rel="preconnect" href="https://fonts.googleapis.com" crossorigin>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Playfair+Display:wght@400;700&family=Roboto+Slab:wght@400;700&display=swap" rel="stylesheet">
<style>
:root{--bg:#0f1220;--panel:#121527;--panel2:#0d1020;--text:#e8ebff;--muted:#9aa3c7;--accent:#5f8cff;--accent2:#9f78ff;--radius:16px;--gap:14px}
*{box-sizing:border-box}html,body{margin:0;padding:0;background:linear-gradient(120deg,#0b0f1f,#141a33 60%,#0b0f1f);color:var(--text);font:14px/1.4 Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Arial}
.app{display:grid;grid-template-columns:360px 1fr;gap:var(--gap);min-height:100svh;padding:var(--gap)}
.card{background:linear-gradient(180deg,var(--panel),var(--panel2));border:1px solid #1b2144;border-radius:var(--radius);box-shadow:0 10px 30px rgba(0,0,0,.35)}
.controls{padding:16px}
.controls h1{margin:0 0 10px 0;font:700 18px/1.2 Montserrat,system-ui}
.row{display:flex;gap:10px;margin:10px 0}
.row label{display:block;font:600 12px/1 Montserrat,system-ui;color:var(--muted);letter-spacing:.02em}
.ctrl{display:flex;flex-direction:column;gap:6px;flex:1}
input[type="text"],textarea,select{background:#0e1330;border:1px solid #20295a;border-radius:10px;color:var(--text);padding:10px 12px;outline:none}
textarea{min-height:90px;resize:vertical}
.btns{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
.btn{border:1px solid #24306a;background:linear-gradient(180deg,#1a2352,#0f1847);color:#eaf0ff;border-radius:999px;padding:10px 14px;font-weight:700;letter-spacing:.02em;cursor:pointer;user-select:none}
.btn:active{transform:translateY(1px)}
.btn.secondary{background:#0d1438}
.badge{display:inline-block;border:1px solid #2a356f;background:#121a45;border-radius:999px;padding:6px 9px;color:#b9c2e8;font:600 12px/1 Montserrat}
.preview{position:relative;display:flex;align-items:center;justify-content:center;padding:12px}
.canvas-wrap{position:relative;border-radius:var(--radius);overflow:hidden;background:#0a0e22;border:1px solid #1b2144;max-width:100%;width:100%}
canvas{display:block;width:100%;height:auto}
.tips{margin:8px 0 0 0;color:var(--muted);font:12px/1.3 Montserrat}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.align{display:flex;gap:8px}
.align input{display:none}
.align label{flex:1;text-align:center;padding:8px 10px;border:1px solid #263372;border-radius:10px;background:#0d1438;cursor:pointer;user-select:none}
.align input:checked+label{border-color:var(--accent);box-shadow:0 0 0 1px var(--accent) inset}
footer{padding:10px 16px;color:var(--muted);font:12px/1.4 Montserrat;border-top:1px solid #1b2144}
.kb{display:inline-block;margin-left:6px;padding:2px 8px;border-radius:6px;background:#0f1537;border:1px solid #263372;color:#b9c2e8}
.small{font-size:12px;color:var(--muted)}
.lite{opacity:.8}
@media(max-width:980px){.app{grid-template-columns:1fr}.preview{order:-1}}
.mbtm{margin-bottom:10px;}
.credits{display:block;text-align:center;font-size:14px;margin:20px auto 10px auto;color:#99F;}
footer a, .credits a{color:#3CF;text-decoration:none;opacity:.6;}footer a:hover, .credits a:hover{color:#3CF;text-decoration:none;opacity:1;}
</style>
</head>
<body>
<div class="app">
  <section class="card controls" aria-label="Controls">
    <h1>Quote Image Maker <span class="badge">client-side only</span></h1>

    <div class="row grid">
      <div class="ctrl">
        <label for="size">Canvas Size</label>
        <select id="size" aria-label="Canvas size">
          <option value="post">FB Post • 1080×1080</option>
          <option value="cover">FB Cover • 820×312</option>
        </select>
      </div>
      <div class="ctrl">
        <label for="bg">Background (Library)</label>
        <select id="bg" aria-label="Background library">
          <option value="gradient-aurora">Aurora Gradient</option>
          <option value="gradient-sunset">Sunset Gradient</option>
          <option value="gradient-midnight">Midnight Gradient</option>
          <option value="pattern-wave">Wave Pattern</option>
          <option value="pattern-mesh">Soft Mesh</option>
          <option value="pattern-grid">Subtle Grid</option>
          <option value="custom">Custom Upload…</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div class="ctrl">
        <label for="upload">Upload Custom Background (kept in browser)</label>
        <input id="upload" type="file" accept="image/*" aria-label="Upload background image">
      </div>
    </div>

    <div class="row">
      <div class="ctrl">
        <label for="text">Your Quote</label>
        <textarea id="text" placeholder="Type your quote… (Drag it in the preview)"></textarea>
      </div>
    </div>

    <div class="row grid">
      <div class="ctrl">
        <label for="font">Font</label>
        <select id="font">
          <option value="Montserrat">Montserrat</option>
          <option value="Playfair Display">Playfair Display</option>
          <option value="Roboto Slab">Roboto Slab</option>
        </select>
      </div>
      <div class="ctrl">
        <label for="sizePx">Font Size</label>
        <input id="sizePx" type="range" min="16" max="160" value="64">
      </div>
    </div>

    <div class="row grid">
      <div class="ctrl">
        <label for="color">Text Color</label>
        <input id="color" type="color" value="#ffffff">
      </div>
      <div class="ctrl">
        <label>Alignment</label>
        <div class="align" role="radiogroup" aria-label="Text alignment">
          <input id="al-l" name="align" type="radio" value="left" checked><label for="al-l">Left</label>
          <input id="al-c" name="align" type="radio" value="center"><label for="al-c">Center</label>
          <input id="al-r" name="align" type="radio" value="right"><label for="al-r">Right</label>
        </div>
      </div>
    </div>

    <!-- ICONS SECTION -->
    <div class="row" style="margin-top:18px">
      <div class="ctrl">
        <label for="iconLib">Stickers / Icons</label>
        <div class="row" style="margin:0;align-items:end">
          <div class="ctrl" style="flex:2">
            <select id="iconLib" aria-label="Icon library">
              <!-- filled by JS -->
            </select>
            <span class="small lite">Vector SVGs for crisp scaling; add your own easily in code.</span>
          </div>
          <div class="ctrl" style="flex:1">
            <button id="btnAddIcon" class="btn" type="button" aria-label="Add icon">Add icon</button>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="ctrl">
        <label for="iconUpload">Upload Custom Icon (SVG/PNG)</label>
        <input id="iconUpload" type="file" accept=".svg,image/svg+xml,image/png,image/webp,image/jpeg" aria-label="Upload custom icon">
      </div>
    </div>

    <div class="row grid">
      <div class="ctrl">
        <label for="iconScale">Icon Size</label>
        <input id="iconScale" type="range" min="0.2" max="3" step="0.05" value="1">
      </div>
      <div class="ctrl">
        <label for="iconRotate">Icon Rotation</label>
        <input id="iconRotate" type="range" min="-180" max="180" step="1" value="0">
      </div>
    </div>

    <div class="btns">
      <button id="btnIconDelete" class="btn secondary" type="button" aria-label="Delete selected icon">Delete Selected Icon</button>
      <button id="btnClear" class="btn secondary" type="button" aria-label="Clear text">Clear Text</button>
      <button id="btnReset" class="btn secondary" type="button" aria-label="Reset page">Reset</button>
      <button id="btnDownload" class="btn" type="button" aria-label="Download PNG">Download PNG</button>
    </div>

    <p class="tips">Tips: Click an icon to select • Drag to move • Hold <span class="kb">Shift</span> to lock axis • Use sliders to size/rotate • Everything stays local.</p>

    <footer>Fonts via Google Fonts; images never leave your device.<br>
    </footer>
  </section>

  <section class="card preview" aria-label="Preview">
    <div class="canvas-wrap">
      <canvas id="c" width="1080" height="1080" aria-label="Preview canvas"></canvas>
    </div>
  </section>
</div>
<div class="credits"><a href="https://wiki.dascent-sigils.com/index.php/Pocket_WebApps/Quote_Image_Maker" target="_blank">Click here for Documentation</a><br>Pocket WebApp by <a href="https://wiki.dascent-sigils.com/index.php/Ai/ChatGPT">ChatGPT</a> for <a href="https://www.reddit.com/r/DoneByAi/">r/DoneByAi</a></div>
<script>
(function(){
  const $=s=>document.querySelector(s);
  const canvas=$('#c'); const ctx=canvas.getContext('2d');
  const dpr= Math.max(1, Math.min(window.devicePixelRatio||1,2));

  // --- ICON LIBRARY (EASY TO EXTEND) ---
  // Add new icons by pushing {id,name,src} to ICONS. src should be a data URI (SVG recommended) or a tiny PNG/WebP.
  const ICONS = [
    {id:'heart', name:'Heart', src:svgURI(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M50 86s-7-6-15-13C21 60 8 49 8 34 8 22 18 12 30 12c8 0 14 5 20 12 6-7 12-12 20-12 12 0 22 10 22 22 0 15-13 26-27 39-8 7-15 13-15 13z' fill='#ff4d6d' stroke='rgba(0,0,0,.35)' stroke-width='2'/></svg>`)},
    {id:'glasses', name:'Glasses', src:svgURI(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 80'><g fill='none' stroke='#ffffff' stroke-width='6' stroke-linecap='round'><path d='M10 40h40c10 0 18 8 18 18s-8 18-18 18H30c-10 0-18-8-18-18V40z' opacity='.9'/><path d='M190 40h-40c-10 0-18 8-18 18s8 18 18 18h20c10 0 18-8 18-18V40z' opacity='.9'/><path d='M90 40h20'/></g></svg>`)},
    {id:'star', name:'Star', src:svgURI(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M50 5l12 28 31 3-24 20 8 30-27-15-27 15 8-30-24-20 31-3z' fill='#ffd166' stroke='rgba(0,0,0,.35)' stroke-width='2'/></svg>`)},
    {id:'sparkles', name:'Sparkles', src:svgURI(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 120 60'><g fill='#fff3b0'><path d='M20 30l4 10 10 4-10 4-4 10-4-10-10-4 10-4z' opacity='.9'/><path d='M80 20l3 8 8 3-8 3-3 8-3-8-8-3 8-3z' opacity='.8'/><circle cx='105' cy='45' r='3' opacity='.8'/></g></svg>`)},
  ];

  function svgURI(markup){
    return 'data:image/svg+xml;charset=UTF-8,'+encodeURIComponent(markup);
  }

  const state={
    w:1080,h:1080,
    bg:{type:'gradient-aurora',img:null,svg:null},
    text:'',font:'Montserrat',size:64,color:'#ffffff',align:'left',
    x:100,y:150,drag:false,dragOffX:0,dragOffY:0,wrapPad:40,
    icons:[], // {id, name, img, x,y, scale, rot, w,h}
    selectedIconIndex:-1,
    dragging:'none', // 'text' or 'icon'
    dragOffIX:0,dragOffIY:0
  };

  // High-DPI scaling
  function resizeCanvas(pxW,pxH){
    state.w=pxW; state.h=pxH;
    canvas.width=pxW*dpr; canvas.height=pxH*dpr;
    canvas.style.width=pxW+'px'; canvas.style.height='auto';
    ctx.setTransform(dpr,0,0,dpr,0,0);
    render();
  }

  // Background library as SVG data URIs
  function libPattern(kind,w,h){
    w=w||state.w; h=h||state.h;
    if(kind==='pattern-wave'){
      return svgURI(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${w} ${h}'><defs><linearGradient id='g' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='#3b59ff'/><stop offset='1' stop-color='#9f78ff'/></linearGradient></defs><rect width='100%' height='100%' fill='url(#g)'/><path d='M0 ${h*0.6} C ${w*.2} ${h*.5}, ${w*.4} ${h*.7}, ${w*.6} ${h*.6} S ${w*.9} ${h*.7}, ${w} ${h*.6} V ${h} H 0 Z' fill='rgba(255,255,255,.08)'/></svg>`);
    }
    if(kind==='pattern-mesh'){
      return svgURI(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${w} ${h}'><defs><radialGradient id='m1' cx='0.2' cy='0.2' r='0.8'><stop offset='0' stop-color='#6f86ff'/><stop offset='1' stop-color='#0a0f2b'/></radialGradient><radialGradient id='m2' cx='0.8' cy='0.8' r='0.9'><stop offset='0' stop-color='#a37aff'/><stop offset='1' stop-color='transparent'/></radialGradient></defs><rect width='100%' height='100%' fill='url(#m1)'/><rect width='100%' height='100%' fill='url(#m2)'/></svg>`);
    }
    if(kind==='pattern-grid'){
      return svgURI(`<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 ${w} ${h}'><defs><linearGradient id='bg' x1='0' y1='0' x2='1' y2='1'><stop offset='0' stop-color='#111633'/><stop offset='1' stop-color='#0a0e22'/></linearGradient><pattern id='p' width='40' height='40' patternUnits='userSpaceOnUse'><path d='M0 0H40V40H0Z M0 0V40 M0 0H40' stroke='rgba(255,255,255,.05)' stroke-width='1' fill='none'/></pattern></defs><rect width='100%' height='100%' fill='url(#bg)'/><rect width='100%' height='100%' fill='url(#p)'/></svg>`);
    }
    return null;
  }

  function drawBackground(){
    const w=state.w,h=state.h;
    if(state.bg.type.startsWith('gradient-')){
      const g = state.bg.type==='gradient-aurora'
        ? (()=>{const grd=ctx.createLinearGradient(0,0,w,h);grd.addColorStop(0,'#0e1a5a');grd.addColorStop(.5,'#3b59ff');grd.addColorStop(1,'#9f78ff');return grd;})()
        : state.bg.type==='gradient-sunset'
        ? (()=>{const grd=ctx.createLinearGradient(0,0,0,h);grd.addColorStop(0,'#ff9966');grd.addColorStop(1,'#662d8c');return grd;})()
        : (()=>{const grd=ctx.createRadialGradient(w*.7,h*.3,h*.1,w*.5,h*.5,Math.max(w,h));grd.addColorStop(0,'#0b102c');grd.addColorStop(1,'#000');return grd;})();
      ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
      if(state.bg.type==='gradient-aurora'){
        ctx.fillStyle='rgba(255,255,255,.06)';ctx.beginPath();ctx.moveTo(0,h*.65);ctx.bezierCurveTo(w*.25,h*.55,w*.45,h*.78,w*.65,h*.68);ctx.bezierCurveTo(w*.85,h*.58,w*.95,h*.7,w,h*.62);ctx.lineTo(w,h);ctx.lineTo(0,h);ctx.closePath();ctx.fill();
      }
    }else if(state.bg.type.startsWith('pattern-')){
      const img=new Image(); img.decoding='async'; img.onload=()=>{ctx.drawImage(img,0,0,w,h); drawIcons(ctx); drawText();}; img.src=libPattern(state.bg.type,w,h);
      return; // text + icons drawn in onload
    }else if(state.bg.img){
      const img=state.bg.img;
      const cw=w,ch=h; // cover
      const ir=img.width/img.height;
      let dw=cw,dh=dw/ir; if(dh<ch){dh=ch;dw=dh*ir}
      const dx=(cw-dw)/2,dy=(ch-dh)/2;
      ctx.drawImage(img,dx,dy,dw,dh);
    }else{
      ctx.fillStyle='#0a0e22';ctx.fillRect(0,0,w,h);
    }
  }

  // --- ICONS RENDERING ---
  function drawIcons(targetCtx){
    targetCtx = targetCtx || ctx;
    for(let i=0;i<state.icons.length;i++){
      const ic=state.icons[i]; if(!ic.img) continue;
      targetCtx.save();
      targetCtx.translate(ic.x, ic.y);
      targetCtx.rotate(ic.rot*Math.PI/180);
      const w=ic.w*ic.scale, h=ic.h*ic.scale;
      targetCtx.drawImage(ic.img, -w/2, -h/2, w, h);
      // selection outline
      if(i===state.selectedIconIndex && targetCtx===ctx){
        targetCtx.strokeStyle='rgba(255,255,255,.8)';
        targetCtx.setLineDash([6,4]);
        targetCtx.lineWidth=1.5;
        targetCtx.strokeRect(-w/2, -h/2, w, h);
      }
      targetCtx.restore();
    }
  }

  // TEXT
  function wrapLines(text,maxWidth){
    const words=(text||'').split(/\s+/); const lines=[]; let line='';
    for(const w of words){
      const tryLine=line?line+' '+w:w;
      if(ctx.measureText(tryLine).width<=maxWidth){line=tryLine}else{if(line)lines.push(line); line=w}
    }
    if(line)lines.push(line);
    return lines.join('\n').split('\n');
  }
  function drawText(){
    const w=state.w,h=state.h;
    ctx.font=`${state.size}px "${state.font}", system-ui, sans-serif`;
    ctx.textAlign= state.align==='center'?'center':state.align==='right'?'right':'left';
    ctx.textBaseline='top';
    ctx.fillStyle=state.color;
    const maxW=w-state.wrapPad*2;
    const lines=wrapLines(state.text,maxW);
    const lineH=state.size*1.25;
    let widest=0; for(const ln of lines){widest=Math.max(widest,ctx.measureText(ln).width)}
    const totalH=lines.length*lineH;
    const startX = state.x;
    const startY = state.y;
    ctx.save();
    ctx.shadowColor='rgba(0,0,0,.35)'; ctx.shadowBlur=Math.max(6, state.size*.12); ctx.shadowOffsetY=Math.max(2, state.size*.06);
    for(let i=0;i<lines.length;i++){ctx.fillText(lines[i],startX,startY+i*lineH)}
    ctx.restore();
    const left = state.align==='left'?startX : state.align==='center'?startX-widest/2 : startX-widest;
    state.hitbox={x:left, y:startY, w:widest, h:totalH};
  }

  function render(){
    ctx.clearRect(0,0,state.w,state.h);
    drawBackground();
    if(!state.bg.type.startsWith('pattern-')){ // patterns call chained
      drawIcons(ctx);
      drawText();
    }
  }

  // --- DOWNLOAD (includes icons) ---
  function downloadPNG(){
    const out=document.createElement('canvas'); const octx=out.getContext('2d');
    out.width=state.w; out.height=state.h;

    // Background
    if(state.bg.type.startsWith('gradient-')){
      const g = state.bg.type==='gradient-aurora'
        ? (()=>{const grd=octx.createLinearGradient(0,0,out.width,out.height);grd.addColorStop(0,'#0e1a5a');grd.addColorStop(.5,'#3b59ff');grd.addColorStop(1,'#9f78ff');return grd;})()
        : state.bg.type==='gradient-sunset'
        ? (()=>{const grd=octx.createLinearGradient(0,0,0,out.height);grd.addColorStop(0,'#ff9966');grd.addColorStop(1,'#662d8c');return grd;})()
        : (()=>{const grd=octx.createRadialGradient(out.width*.7,out.height*.3,out.height*.1,out.width*.5,out.height*.5,Math.max(out.width,out.height));grd.addColorStop(0,'#0b102c');grd.addColorStop(1,'#000');return grd;})();
      octx.fillStyle=g; octx.fillRect(0,0,out.width,out.height);
      if(state.bg.type==='gradient-aurora'){
        octx.fillStyle='rgba(255,255,255,.06)';octx.beginPath();octx.moveTo(0,out.height*.65);octx.bezierCurveTo(out.width*.25,out.height*.55,out.width*.45,out.height*.78,out.width*.65,out.height*.68);octx.bezierCurveTo(out.width*.85,out.height*.58,out.width*.95,out.height*.7,out.width,out.height*.62);octx.lineTo(out.width,out.height);octx.lineTo(0,out.height);octx.closePath();octx.fill();
      }
    }else if(state.bg.type.startsWith('pattern-')){
      const img=new Image(); img.onload=()=>{octx.drawImage(img,0,0,out.width,out.height); drawOutIcons(); drawOutText();};
      img.src=libPattern(state.bg.type,out.width,out.height);
      return;
    }else if(state.bg.img){
      const img=state.bg.img;
      const cw=out.width,ch=out.height, ir=img.width/img.height;
      let dw=cw,dh=dw/ir; if(dh<ch){dh=ch;dw=dh*ir}
      const dx=(cw-dw)/2,dy=(ch-dh)/2; octx.drawImage(img,dx,dy,dw,dh);
    }else{
      octx.fillStyle='#0a0e22'; octx.fillRect(0,0,out.width,out.height);
    }

    drawOutIcons(); drawOutText();

    function drawOutIcons(){
      for(const ic of state.icons){
        if(!ic.img) continue;
        octx.save(); octx.translate(ic.x,ic.y); octx.rotate(ic.rot*Math.PI/180);
        const w=ic.w*ic.scale, h=ic.h*ic.scale;
        octx.drawImage(ic.img, -w/2, -h/2, w, h);
        octx.restore();
      }
    }
    function drawOutText(){
      const o=octx;
      o.font=`${state.size}px "${state.font}", system-ui, sans-serif`;
      o.textAlign= state.align==='center'?'center':state.align==='right'?'right':'left';
      o.textBaseline='top'; o.fillStyle=state.color;
      const maxW=out.width-state.wrapPad*2;
      const words=(state.text||'').split(/\s+/); const lines=[]; let line='';
      for(const w of words){const tryLine=line?line+' '+w:w; if(o.measureText(tryLine).width<=maxW){line=tryLine}else{if(line)lines.push(line); line=w}}
      if(line)lines.push(line);
      const lineH=state.size*1.25;
      for(let i=0;i<lines.length;i++){o.save();o.shadowColor='rgba(0,0,0,.35)';o.shadowBlur=Math.max(6, state.size*.12);o.shadowOffsetY=Math.max(2, state.size*.06);o.fillText(lines[i],state.x,state.y+i*lineH);o.restore();}
      const a=document.createElement('a');
      const ts=new Date(); const pad=n=>String(n).padStart(2,'0');
      const name=`quote_${ts.getFullYear()}-${pad(ts.getMonth()+1)}-${pad(ts.getDate())}_${pad(ts.getHours())}${pad(ts.getMinutes())}${pad(ts.getSeconds())}.png`;
      a.href=out.toDataURL('image/png'); a.download=name; a.click();
    }
  }

  // --- UI BINDINGS ---
  $('#size').addEventListener('change',e=>{
    const v=e.target.value;
    if(v==='post'){resizeCanvas(1080,1080); }
    if(v==='cover'){resizeCanvas(820,312); state.x=80; state.y=80;}
  });

  $('#bg').addEventListener('change',e=>{
    const v=e.target.value;
    state.bg.type=v;
    if(v!=='custom'){ state.bg.img=null; state.bg.svg=null; }
    render();
  });

  $('#upload').addEventListener('change',e=>{
    const file=e.target.files&&e.target.files[0]; if(!file) return;
    const url=URL.createObjectURL(file); const img=new Image();
    img.onload=()=>{state.bg={type:'custom',img:img,svg:null}; URL.revokeObjectURL(url); render();}
    img.src=url;
    $('#bg').value='custom';
  });

  $('#text').addEventListener('input',e=>{state.text=e.target.value; render();});
  $('#font').addEventListener('change',e=>{
    state.font=e.target.value;
    document.fonts&&document.fonts.ready.then(render).catch(render);
  });
  $('#sizePx').addEventListener('input',e=>{state.size=parseInt(e.target.value,10)||64; render();});
  $('#color').addEventListener('input',e=>{state.color=e.target.value; render();});
  document.querySelectorAll('input[name="align"]').forEach(r=>r.addEventListener('change',e=>{state.align=e.target.value; render();}));

  $('#btnClear').addEventListener('click',()=>{state.text=''; $('#text').value=''; render();});
  $('#btnReset').addEventListener('click',()=>{location.reload();});
  $('#btnDownload').addEventListener('click',downloadPNG);

  // --- ICONS UI ---
  // populate library
  const libSel = $('#iconLib');
  function populateLib(){
    libSel.innerHTML='';
    ICONS.forEach(ic=>{
      const opt=document.createElement('option');
      opt.value=ic.id; opt.textContent=ic.name; libSel.appendChild(opt);
    });
  }
  populateLib();

  $('#btnAddIcon').addEventListener('click',()=>{
    const id=libSel.value;
    const def = ICONS.find(x=>x.id===id);
    if(!def) return;
    const img=new Image(); img.decoding='async';
    img.onload=()=>{
      const baseSize = Math.min(state.w,state.h)*0.18; // reasonable default
      const ratio = img.width/img.height || 1;
      const w = baseSize; const h = baseSize/ratio;
      state.icons.push({
        id:def.id, name:def.name, img,
        x: state.w*0.5, y: state.h*0.5,
        scale: 1, rot: 0, w: w, h: h
      });
      state.selectedIconIndex = state.icons.length-1;
      syncIconSliders();
      render();
    };
    img.src = def.src;
  });

  $('#iconUpload').addEventListener('change',e=>{
    const file=e.target.files&&e.target.files[0]; if(!file) return;
    const url=URL.createObjectURL(file); const img=new Image();
    img.onload=()=>{
      const baseSize = Math.min(state.w,state.h)*0.2;
      const ratio = img.width/img.height || 1;
      const w = baseSize; const h = baseSize/ratio;
      state.icons.push({id:'custom',name:file.name,img,x:state.w*.5,y:state.h*.5,scale:1,rot:0,w,h});
      state.selectedIconIndex = state.icons.length-1;
      URL.revokeObjectURL(url);
      syncIconSliders();
      render();
    };
    img.src=url;
    e.target.value=''; // reset input
  });

  // sliders apply to selected icon
  function syncIconSliders(){
    const i=state.selectedIconIndex;
    const has=i>=0 && state.icons[i];
    $('#iconScale').value = has ? String(state.icons[i].scale) : '1';
    $('#iconRotate').value= has ? String(state.icons[i].rot)   : '0';
  }
  $('#iconScale').addEventListener('input',e=>{
    const i=state.selectedIconIndex; if(i<0) return;
    state.icons[i].scale = parseFloat(e.target.value)||1;
    render();
  });
  $('#iconRotate').addEventListener('input',e=>{
    const i=state.selectedIconIndex; if(i<0) return;
    state.icons[i].rot = parseFloat(e.target.value)||0;
    render();
  });
  $('#btnIconDelete').addEventListener('click',()=>{
    const i=state.selectedIconIndex; if(i<0) return;
    state.icons.splice(i,1);
    state.selectedIconIndex=-1;
    syncIconSliders();
    render();
  });

  // --- HIT TEST HELPERS ---
  function textHit(x,y){
    const b=state.hitbox; return b && x>=b.x && x<=b.x+b.w && y>=b.y && y<=b.y+b.h;
  }
  function iconHit(x,y){
    // iterate reverse (top-most first)
    for(let i=state.icons.length-1;i>=0;i--){
      const ic=state.icons[i];
      // inverse-transform the point to icon's local space to test axis-aligned bbox
      const cos=Math.cos(-ic.rot*Math.PI/180), sin=Math.sin(-ic.rot*Math.PI/180);
      const dx=x-ic.x, dy=y-ic.y;
      const lx=dx*cos - dy*sin, ly=dx*sin + dy*cos;
      const hw=(ic.w*ic.scale)/2, hh=(ic.h*ic.scale)/2;
      if(lx>=-hw && lx<=hw && ly>=-hh && ly<=hh) return i;
    }
    return -1;
  }
  function pointerXY(evt){
    const r=canvas.getBoundingClientRect();
    return {x:(evt.clientX - r.left)/r.width*state.w, y:(evt.clientY - r.top)/r.height*state.h}
  }

  // --- POINTER INTERACTION (text + icons) ---
  let lockAxis=null;
  canvas.addEventListener('pointerdown',e=>{
    const p=pointerXY(e);
    // priority: icons on top
    const iHit = iconHit(p.x,p.y);
    if(iHit>=0){
      state.selectedIconIndex=iHit; syncIconSliders();
      state.dragging='icon';
      const ic=state.icons[iHit];
      state.dragOffIX = p.x - ic.x;
      state.dragOffIY = p.y - ic.y;
      lockAxis=e.shiftKey? 'axisPending': null;
      canvas.setPointerCapture(e.pointerId);
      render(); // to show selection box
      return;
    }
    // then text
    if(textHit(p.x,p.y)){
      state.dragging='text';
      state.drag=true; state.dragOffX=p.x-state.x; state.dragOffY=p.y-state.y;
      lockAxis=e.shiftKey? 'axisPending': null;
      canvas.setPointerCapture(e.pointerId);
      return;
    }
    // click on empty area clears icon selection
    state.selectedIconIndex=-1; syncIconSliders(); render();
  });

  canvas.addEventListener('pointermove',e=>{
    if(state.dragging==='none') return;
    const p=pointerXY(e);
    if(lockAxis==='axisPending'){
      // decide on first move
      lockAxis = 'free';
    }
    if(state.dragging==='text'){
      const nx = p.x - state.dragOffX;
      const ny = p.y - state.dragOffY;
      state.x = lockAxis==='y'? state.x : Math.max(10, Math.min(state.w-10, nx));
      state.y = lockAxis==='x'? state.y : Math.max(10, Math.min(state.h-10, ny));
      render();
    }else if(state.dragging==='icon'){
      const i=state.selectedIconIndex; if(i<0) return;
      const nx = p.x - state.dragOffIX;
      const ny = p.y - state.dragOffIY;
      state.icons[i].x = Math.max(0, Math.min(state.w, nx));
      state.icons[i].y = Math.max(0, Math.min(state.h, ny));
      render();
    }
  });

  window.addEventListener('pointerup',e=>{
    state.drag=false; state.dragging='none'; lockAxis=null;
    try{canvas.releasePointerCapture(e.pointerId)}catch(_){}
  });

  // INIT
  function initIconDropdown(){
    const sel=$('#iconLib');
    if(!sel.options.length) populateLib();
  }
  initIconDropdown();
  resizeCanvas(1080,1080);
  document.fonts&&document.fonts.ready.then(render).catch(render);
})();
</script>
</body>
</html>
